# Railway Simulation Backend

A comprehensive railway simulation backend that implements a complete step-by-step simulation system for train operations, conflict resolution, and performance analysis.

## Features

### Phase 1: Data Loading and Preparation
- **GA Output Loading**: Load train schedules and paths from JSON or CSV files generated by Genetic Algorithms
- **Railway Network Data**: Load static network data including stations, blocks, junctions, and connectivity
- **Train Path Building**: Match GA output with actual network layout to create structured train routes
- **Data Validation**: Check for inconsistencies like overlapping block occupancy and missing stations

### Phase 2: Train Initialization
- **Comprehensive Train Objects**: Each train includes detailed properties like speed, direction, timing, and status
- **Initial State Setup**: Place trains at starting positions with proper timing counters
- **Event Queue**: Precompute scheduled events for efficient simulation

### Phase 3: Simulation Engine
- **Fixed Time Steps**: Configurable simulation time increments (default: 1 second)
- **Physics-Based Movement**: Realistic train acceleration, deceleration, and speed control
- **Collision Detection**: Ensure no two trains occupy the same block simultaneously
- **Conflict Resolution**: Multiple resolution strategies (priority, first-come-first-served, FIFO)
- **Event Processing**: Handle arrivals, departures, block entries/exits, and delays
- **Real-time Metrics**: Collect delays, throughput, block utilization, and waiting times

### Phase 4: Logging and Analytics
- **Structured Logs**: Detailed simulation logs for each train at each timestep
- **Summary Statistics**: Comprehensive metrics including max/average delays and throughput
- **Data Export**: JSON and CSV export capabilities for analysis and visualization

### Phase 5: API Integration
- **RESTful API**: FastAPI-based endpoints for simulation control
- **Real-time Data**: WebSocket support for live simulation updates
- **CORS Support**: Cross-origin requests for frontend integration
- **Multiple Input Formats**: Support for direct API calls and GA file loading

### Phase 6: Testing and Validation
- **Unit Tests**: Comprehensive test suite for all modules
- **Integration Tests**: End-to-end simulation validation
- **Conflict Scenarios**: Specialized tests for conflict resolution
- **Performance Testing**: Validation of simulation accuracy and speed

## Installation

1. Install Python 3.8 or higher
2. Install dependencies:
```bash
pip install -r requirements.txt
```

## Quick Start

### Basic Simulation

```python
from simulation.data_loader import DataLoader
from simulation.engine import SimulationEngine

# Load network and GA data
data_loader = DataLoader()
network = data_loader.load_railway_network(network_config)
ga_output = data_loader.load_ga_output("ga_results.json")

# Build train paths and initialize
train_paths = data_loader.build_train_paths(ga_output, network)
trains = data_loader.initialize_trains(train_paths)

# Run simulation
engine = SimulationEngine(network, time_step=1.0)
for train in trains:
    engine.add_train(train)

logs = engine.run_simulation(max_time=3600, config={"priority_rule": "priority"})
```

### API Usage

Start the server:
```bash
uvicorn api:app --reload --host 0.0.0.0 --port 8000
```

Run simulation via API:
```bash
curl -X POST "http://localhost:8000/simulate" \
  -H "Content-Type: application/json" \
  -d '{
    "trains": [
      {
        "id": "T001",
        "name": "Express Train",
        "from_station": "S1",
        "to_station": "S2",
        "departure_time": 0,
        "arrival_time": 3600,
        "priority": 1
      }
    ],
    "priority_rule": "priority",
    "max_time": 3600
  }'
```

## API Endpoints

### Core Endpoints
- `GET /health` - Health check
- `GET /network/sample` - Get sample network configuration
- `POST /simulate` - Run simulation with train configurations
- `POST /simulate/ga` - Run simulation from GA output file
- `GET /metrics/export/{simulation_id}` - Export simulation metrics

### Request/Response Formats

#### Simulation Request
```json
{
  "trains": [
    {
      "id": "T001",
      "name": "Express Train",
      "from_station": "S1",
      "to_station": "S2",
      "departure_time": 0,
      "arrival_time": 3600,
      "priority": 1,
      "train_type": "Express",
      "max_speed": 120.0,
      "length": 200.0,
      "max_capacity": 500
    }
  ],
  "network_config": { ... },
  "priority_rule": "priority",
  "max_time": 3600,
  "time_step": 1.0
}
```

#### Simulation Response
```json
{
  "success": true,
  "logs": [
    {
      "time": 100.0,
      "train_id": "T001",
      "current_block": "B1",
      "current_station": "S1",
      "status": "moving",
      "delay": 0,
      "speed": 80.0,
      "position": [50.0, 0.0]
    }
  ],
  "metrics": {
    "total_delays": 120,
    "max_delay": 60,
    "average_delay": 30.0,
    "total_throughput": 1,
    "conflict_count": 2,
    "simulation_time": 3600.0
  },
  "network": { ... },
  "message": "Simulation completed successfully"
}
```

## Data Models

### Train
- **Basic Info**: id, name, type, priority
- **Route**: station sequence, block sequence
- **Timing**: scheduled/actual departure/arrival times
- **State**: current station/block, speed, direction, status
- **Physics**: acceleration, deceleration, max speed, length
- **Capacity**: passenger count, max capacity

### Station
- **Location**: position coordinates, connected blocks
- **Platforms**: platform details, occupancy, dwell times
- **Signals**: signal positions and status
- **Capacity**: station capacity limits

### Block
- **Physical**: length, max speed, position
- **Status**: free, occupied, reserved
- **Connectivity**: connected blocks, junctions
- **Occupancy**: current train, reserved train

### Simulation Log
- **Timestamp**: simulation time
- **Train State**: current location, status, speed
- **Metrics**: delay, position coordinates
- **Events**: list of events at this timestep

## Configuration Options

### Priority Rules
- `priority`: Resolve conflicts by train priority (higher number = higher priority)
- `first_come`: First come, first served based on arrival time
- `fifo`: First in, first out based on simulation order

### Simulation Parameters
- `time_step`: Simulation time increment in seconds (default: 1.0)
- `max_time`: Maximum simulation duration in seconds
- `max_speed`: Maximum train speed in km/h
- `dwell_time`: Station dwell time in seconds

## Examples

### Example 1: Basic Simulation
```python
python example_simulation.py
```

### Example 2: Run Tests
```python
python test_simulation.py
```

### Example 3: API Server
```python
uvicorn api:app --reload
```

## File Structure

```
backend-simulation/
├── api.py                 # FastAPI application
├── requirements.txt       # Python dependencies
├── example_simulation.py  # Example usage script
├── test_simulation.py     # Test suite
├── README.md             # This file
└── simulation/
    ├── __init__.py
    ├── data.py           # Data models and schemas
    ├── data_loader.py    # Data loading and validation
    └── engine.py         # Simulation engine
```

## Performance Considerations

- **Time Step**: Smaller time steps provide more accuracy but slower simulation
- **Network Size**: Larger networks require more memory and computation
- **Train Count**: More trains increase conflict resolution complexity
- **Simulation Duration**: Longer simulations require more memory for logging

## Extending the System

### Adding New Conflict Resolution Rules
1. Add new method to `SimulationEngine` class
2. Register in `conflict_resolution_rules` dictionary
3. Update API documentation

### Adding New Train Types
1. Extend `Train` model with new properties
2. Update `DataLoader.initialize_trains()` method
3. Modify physics calculations in `SimulationEngine`

### Adding New Metrics
1. Extend `SimulationMetrics` model
2. Update calculation in `SimulationEngine._calculate_metrics()`
3. Include in API response format

## Troubleshooting

### Common Issues
1. **Import Errors**: Ensure all dependencies are installed
2. **Data Validation Errors**: Check network configuration and train data
3. **Memory Issues**: Reduce simulation duration or increase time step
4. **API Errors**: Check request format and required fields

### Debug Mode
Enable debug logging by setting environment variable:
```bash
export SIMULATION_DEBUG=1
```

## Contributing

1. Fork the repository
2. Create a feature branch
3. Add tests for new functionality
4. Ensure all tests pass
5. Submit a pull request

## License

This project is licensed under the MIT License - see the LICENSE file for details.

